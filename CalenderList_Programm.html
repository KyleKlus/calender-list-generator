<!DOCTYPE html>
<html lang="de">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link
    href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
    rel="stylesheet">
<meta author="Kyle Klus">
<style>
    * {
        font-family: "Inter", Arial, sans-serif;
        line-height: 1.2;
        --primary-color: #6F003C;
        --secondary-color: #a40259;
        --tertiary-color: #b05686;
    }

    body {
        margin: 0;
        padding: 0;
    }

    #header {
        text-align: center;
        width: 100vw;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background-color: var(--primary-color);
        color: white;
        height: fit-content;
        margin-bottom: 100px;
    }

    p {
        max-width: 650px;
    }

    italic {
        font-style: italic;
    }

    #calender-input {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        width: 600px;
    }

    #calender-input li {
        background: #eee;
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        list-style-type: none;
        border: 1px solid black;
    }

    #calender-input img {
        height: 64px;
        order: 1;
    }

    #calender-input p {
        line-height: 32px;
        padding-left: 10px;
    }

    #calender-input label,
    #calender-input button {
        background-color: var(--primary-color);
        padding: 5px 10px;
        border-radius: 5px;
        border: 1px ridge black;
        font-size: 0.8rem;
        height: auto;
        color: white;
    }

    #calender-input label:hover,
    #calender-input button:hover {
        background-color: var(--secondary-color);
        color: white;
    }

    #calender-input label:active,
    #calender-input button:active {
        background-color: var(--tertiary-color);
        color: white;
    }

    #calender-input ol {
        padding-left: 0;
    }

    p {
        margin: 0;
    }

    #date-picker {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
        width: 300px;
        margin-bottom: 10px;
    }

    #file-input-page {
        display: flex;
        flex-direction: column;
        width: 100vw;
    }

    #file-input {
        width: 100vw;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        overflow: hidden;
        gap: 8px;
    }

    #file-input-label {
        max-width: 35ch;
        display: block;
        max-height: 1rem;
        word-break: keep-all;
        word-wrap: break-word;
        text-wrap: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
    }

    table {
        border-spacing: 0px 8px;
        padding: 0 8px 8px 8px;
        width: 100%;
    }

    @media print {
        table {
            page-break-inside: auto
        }

        tr.day-header-row {
            page-break-inside: avoid;
            page-break-after: auto
        }
    }

    thead {
        display: table-header-group
    }

    tfoot {
        display: table-footer-group
    }

    th {
        background-color: var(--primary-color);
        color: white;
    }

    th>div {
        display: flex;
        justify-content: flex-start;
        padding: 8px;
    }

    tr.day-header-row th {
        background-color: var(--primary-color);
    }

    tr.day-header-row th:first-child {
        border-top-left-radius: 4px;
        border-bottom-left-radius: 4px;
    }

    tr.day-header-row th:last-child {
        border-top-right-radius: 4px;
        border-bottom-right-radius: 4px;
    }

    td {
        padding: 16px 8px;
        vertical-align: top;
    }

    tr:not(.is-new-day) td {
        border-top: 1px solid var(--primary-color);
    }

    td.event-time {
        white-space: nowrap;
    }
</style>

<body>
    <div id="file-input-page">
        <div id="header">
            <h2>Kyle&apos;s Kalenderlisten-Generator</h2>
        </div>
        <div id="file-input">
            <p>
                <italic>Dieses Tool erstellt eine HTML-Tabelle aus einer ICS Kalenderdatei. Lade die ICS Datei hoch und
                    klicke auf "Umwandeln". Um die Listenansicht als PDF zu erhalten, drucke die Tabelle aus als PDF
                    aus.
                    Dies kann einfach über die Tastenkombination "Strg + P" erfolgen.</italic>
                <br /><br /><br /><br />
            </p>
            <p>Hier kannst du einen Zeitraum auswählen, in dem die Kalenderliste erstellt werden soll:</p>
            <div id="date-picker">
                <input type="date" name="start-date-picker-input" id="start-date-picker-input">
                <p> bis </p>
                <input type="date" name="end-date-picker-input" id="end-date-picker-input">
            </div>

            <div id="calender-input">
                <label id="file-input-label" for="calender">Bitte wähle eine ICS Datei aus</label>
                <input type="file" id="calender" name="calender" accept=".ics" style="display: none;">
                <button id="reset-button">Zurücksetzen</button><button id="convert-button">Umwandeln</button>
            </div>
        </div>

    </div>
    <div id="calender-table" style="display: none;">
        <table>
            <tbody id="calender-table-body">
            </tbody>
        </table>
    </div>
</body>
<script>
    window.addEventListener("load", function () {
        document.getElementById("calender").value = '';
        let label = document.getElementById("file-input-label");

        label.innerHTML = "Bitte wähle eine ICS Datei aus";
        document.getElementById("start-date-picker-input").value = '';
        document.getElementById("end-date-picker-input").value = '';
    });
</script>
<script>
    document.getElementById("calender").addEventListener("change", function (event) {
        event.preventDefault();
        let files = document.getElementById("calender").files;
        let label = document.getElementById("file-input-label");

        if (files.length === 0) {
            label.innerHTML = "Bitte wähle eine ICS Datei aus";
            return;
        }

        const file = files[0];
        label.innerHTML = file.name;
    });
</script>
<script>
    document.getElementById("reset-button").addEventListener("click", function (event) {
        event.preventDefault();
        document.getElementById("calender").value = '';
        let label = document.getElementById("file-input-label");

        label.innerHTML = "Bitte wähle eine ICS Datei aus";
        document.getElementById("start-date-picker-input").value = '';
        document.getElementById("end-date-picker-input").value = '';
    });
</script>
<script type="module">
    import ical from "https://unpkg.com/ical.js/dist/ical.min.js";
    import moment from 'https://cdn.jsdelivr.net/npm/moment@2.30.1/+esm';
    import { DateTime } from 'https://cdn.jsdelivr.net/npm/luxon@2.3.0/+esm';
    import { rrulestr } from 'https://cdn.jsdelivr.net/npm/rrule@2.6.8/+esm';

    const TITLE_TAG = "summary";
    const DESCRIPTION_TAG = "description";
    const LOCATION_TAG = "location";
    const START_TAG = "dtstart";
    const END_TAG = "dtend";
    const DATESTAMP_TAG = "dtstamp";
    const RRULE_TAG = "rrule";

    // Cut off events that are not within bounds
    let cutOffStartDateString = '';
    let cutOffEndDateString = '';
    let cutOffStartDate = undefined;
    let cutOffEndDate = undefined;

    window.addEventListener("load", function () {
        resetPage();
    });

    const calenderInput = document.getElementById("calender");
    const label = document.getElementById("file-input-label");

    if (calenderInput) {
        calenderInput.addEventListener("change", function (event) {
            event.preventDefault();
            let files = event.target.files;

            if (!files || !label) { return }

            if (files.length === 0) {
                label.innerHTML = "Bitte wähle eine ICS Datei aus";
                return;
            }

            const file = files[0];
            label.innerHTML = `Ausgewählt: ${file.name}`;
        });
    }

    const startDatePickerInput = document.getElementById("start-date-picker-input");
    if (startDatePickerInput) {
        startDatePickerInput.addEventListener("change", function (event) {
            event.preventDefault();
            if (event.target !== null) {
                cutOffStartDateString = event.target.value;
                cutOffStartDate = moment(cutOffStartDateString).startOf("day");
            }

        });
    }

    const endDatePickerInput = document.getElementById("end-date-picker-input");
    if (endDatePickerInput) {
        endDatePickerInput.addEventListener("change", function (event) {
            event.preventDefault();
            if (event.target === null) { return; }
            cutOffEndDateString = event.target.value;
            cutOffEndDate = moment(cutOffEndDateString).endOf("day");
        });
    }

    const resetButton = document.getElementById("reset-button");
    if (resetButton) {
        resetButton.addEventListener("click", function (event) {
            event.preventDefault();
            resetPage();
        });
    }

    const convertButton = document.getElementById("convert-button");
    if (convertButton) {
        convertButton.addEventListener("click", function (event) {
            event.preventDefault();
            if (calenderInput === null || calenderInput.files === null) { return; }

            // let file = calenderInput.files[0];
            let file = calenderInput.files[0];
            if (!file) { return; }

            const reader = new FileReader();
            reader.onload = function (e) {
                convertToHTMLTable(e.target.result);
            };
            reader.readAsText(file);
        });
    }

    function resetPage() {
        calenderInput.value = '';

        label.innerHTML = "Bitte wähle eine ICS Datei aus";
        startDatePickerInput.value = '';
        cutOffStartDate = undefined;
        cutOffStartDateString = '';
        endDatePickerInput.value = '';
        cutOffEndDateString = '';
        cutOffEndDate = undefined;
    }

    function convertToHTMLTable(result) {
        const icalContent = result;

        const parsedICalContent = ical.parse(icalContent);
        const vcalendar = new ical.Component(parsedICalContent);
        const vevents = vcalendar.getAllSubcomponents("vevent");

        let eventList = [];

        for (let i = 0; i < vevents.length; i++) {
            const vevent = vevents[i];

            eventList = eventList.concat(parseJCalEvent(vevent));
        }

        eventList = sortAndClean(eventList);

        buildTable(eventList);
    }

    function parseJCalEvent(vevent) {
        const event = new ical.Event(vevent);
        let startDate = moment(event.startDate.toJSDate());
        let endDate = moment(event.endDate.toJSDate());

        if (event.startDate.isDate && endDate.hour() === 0 && endDate.minute() === 0 && endDate.second() === 0) {
            endDate = endDate.subtract(1, 'second');
        }

        let eventList = [];
        // TODO: Fix recurring events with exception dates
        // TODO: Uhrzeit mehrere Tage + wiederholung -> Ganztags
        // TODO: Test props + Über tage hinweg mit zeiten

        // Calc over how many days the event stretches
        let daysNeededForEvent = Math.ceil(moment(endDate).diff(moment(startDate), 'days', true));

        const baseEventObject = {
            title: event.summary === undefined || event.summary === null ? "Kein Titel" : event.summary,
            description: event.description === undefined || event.description === null ? "Keine Beschreibung" : event.description,
            location: event.location === undefined || event.location === null ? "Kein Ort" : event.location,
            start: undefined,
            startDate: undefined,
            startTime: undefined,
            end: undefined,
            endDate: undefined,
            endTime: undefined,
            isDate: false,
            jCalEvent: vevent
        };

        const newEventObjects = buildEventObjects(
            baseEventObject,
            startDate,
            endDate,
            daysNeededForEvent,
            event.startDate.isDate
        )

        if (event.isRecurring()) {
            eventList = eventList.concat(newEventObjects);
        }


        if (event.isRecurring()) {
            let expand = new ical.RecurExpansion({
                component: vevent,
                dtstart: vevent.getFirstPropertyValue('dtstart')
            });

            console.log(vevent);

            let rangeStart = cutOffStartDate !== undefined ? cutOffStartDate : moment(startDate).startOf("day");
            let rangeEnd = cutOffEndDate !== undefined ? cutOffEndDate : moment().add(1, 'year').endOf("day");

            let next = expand.next()
            let originalEndDate = moment(endDate);
            let nextStartDate = moment(next.toJSDate());
            let nextEndDate = moment(nextStartDate).add(daysNeededForEvent, 'days').hour(originalEndDate.hour()).minute(originalEndDate.minute()).second(originalEndDate.second());

            while (next && nextStartDate.isBefore(rangeEnd)) {
                console.log("Next start date: " + nextStartDate.format("YYYY-MM-DD HH:mm:ss"), baseEventObject.title, newEventObjects
                );
                if (nextStartDate.isBefore(rangeStart)) {
                    next = expand.next();
                    if (next === undefined) {
                        break;
                    }
                    nextStartDate = moment(next.toJSDate());
                    nextEndDate = moment(nextStartDate).add(daysNeededForEvent, 'days').hour(originalEndDate.hour()).minute(originalEndDate.minute()).second(originalEndDate.second());
                    continue;
                }

                const recurringEventObjects = buildEventObjects(
                    baseEventObject,
                    nextStartDate,
                    nextEndDate,
                    daysNeededForEvent,
                    event.startDate.isDate
                );

                eventList = eventList.concat(recurringEventObjects);

                next = expand.next();
                if (next === undefined) {
                    break;
                }
                nextStartDate = moment(next.toJSDate());
                nextEndDate = moment(nextStartDate).add(daysNeededForEvent, 'days').hour(originalEndDate.hour()).minute(originalEndDate.minute()).second(originalEndDate.second());
            }
        }
        return eventList;
    }

    function buildEventObjects(baseEventObject, startDate, endDate, eventLengthInDays, isDate) {

        let eventList = [];

        if (eventLengthInDays > 1 || startDate.format("YYYY-MM-DD") !== endDate.format("YYYY-MM-DD")) {
            const firstEventObject = buildEventObjects(
                baseEventObject,
                startDate,
                moment(startDate).endOf("day"),
                1,
                isDate
            )
            eventList = eventList.concat(firstEventObject);

            for (let i = 1; i < eventLengthInDays - 1; i++) {
                let newRecurringStartDate = moment(startDate).add(i, 'day').startOf("day");
                let newRecurringEndDate = newRecurringStartDate.endOf("day");

                const inBetweenEventObject = buildEventObjects(
                    baseEventObject,
                    newRecurringStartDate,
                    newRecurringEndDate,
                    1,
                    true
                );

                eventList = eventList.concat(inBetweenEventObject);
            }

            const lastEventObject = buildEventObjects(
                baseEventObject,
                moment(endDate).startOf("day"),
                endDate,
                1,
                isDate
            )

            eventList = eventList.concat(lastEventObject);
        } else {
            const newEventObject = {
                ...baseEventObject,
                start: startDate.format("YYYY-MM-DDTHH:mm:ss"),
                startDate: !isDate ? startDate.format("YYYY-MM-DD") : undefined,
                startTime: !isDate ? startDate.format("HH:mm:ss") : undefined,
                end: endDate.format("YYYY-MM-DDTHH:mm:ss"),
                endDate: !isDate ? endDate.format("YYYY-MM-DD") : undefined,
                endTime: !isDate ? endDate.format("HH:mm:ss") : undefined,
                isDate: isDate
            }

            eventList.push(newEventObject);
        }

        return eventList;
    }

    function sortAndClean(eventList) {
        // Sort events by start time

        let cleanEventList = eventList.sort(function (a, b) {
            const aStart = moment(a.start);
            const aEnd = moment(a.end);
            const aIsDate = a.isDate;
            const bStart = moment(b.start);
            const bEnd = moment(b.end);
            const bIsDate = b.isDate;

            if (moment(aStart).startOf('day').isBefore(moment(bStart).startOf('day'))) {
                return -1;
            }
            if (moment(aStart).startOf('day').isAfter(moment(bStart).startOf('day'))) {
                return 1;
            }
            if (moment(aStart).startOf('day').isSame(moment(bStart).startOf('day')) && aIsDate) {
                return -1;
            }
            if (moment(aStart).startOf('day').isSame(moment(bStart).startOf('day')) && bIsDate) {
                return 1;
            }
            if (moment(aStart).startOf('day').isSame(moment(bStart).startOf('day')) && aIsDate && bIsDate) {
                return 0;
            }
            if (aStart.isBefore(bStart)) {
                return -1;
            }
            if (aStart.isAfter(bStart)) {
                return 1;
            }
            if (aStart.isSame(bStart)) {
                if (aEnd.isBefore(bEnd)) {
                    return -1;
                }
                if (aEnd.isAfter(bEnd)) {
                    return 1;
                }

                if (aEnd.isSame(bEnd)) {
                    return 0;
                }
            }
        });

        // Remove events that end before the cut off date
        cleanEventList = cleanEventList.filter(function (event, pos) {
            const start = moment(event.start).startOf("day");
            const end = moment(event.end).endOf("day");

            if (pos !== 0 &&
                cleanEventList[pos - 1].title === event.title &&
                cleanEventList[pos - 1].location === event.location &&
                cleanEventList[pos - 1].description === event.description &&
                cleanEventList[pos - 1].start === event.start &&
                cleanEventList[pos - 1].end === event.end &&
                cleanEventList[pos - 1].isDate === event.isDate
            ) {
                return false;
            }

            let keepEvent = true;

            if (cutOffStartDateString !== '') {
                keepEvent = end.isSameOrAfter(moment(cutOffStartDateString));
            }

            if (cutOffEndDateString !== '') {
                keepEvent = keepEvent && start.isSameOrBefore(moment(cutOffEndDateString));
            }

            return keepEvent;
        });

        return cleanEventList;
    }

    function buildTable(eventList) {
        // Set visibility of file input and calender table
        const fileInput = document.getElementById("file-input-page");
        fileInput.style.display = "none";

        const tableContainer = document.getElementById("calender-table");
        tableContainer.style.display = "block";

        // Clear table body
        const tableBody = document.getElementById("calender-table-body");
        tableBody.innerHTML = "";

        // Build table rows
        let currentDate = undefined;
        eventList.forEach(function (eventItem) {
            const isWholeDayEvent = eventItem.isDate;
            const isNewDay = currentDate === undefined ||
                currentDate !== moment(eventItem.start).format("YYYY-MM-DD");

            // Set event time
            const newStartTimeComponents = isWholeDayEvent ? ["00", "00"] : eventItem.startTime.split(":");
            const newStartTime = newStartTimeComponents[0] + ":" + newStartTimeComponents[1];
            const newEndTimeComponents = isWholeDayEvent ? ["23", "59"] : eventItem.endTime.split(":");
            const newEndTime = newEndTimeComponents[0] + ":" + newEndTimeComponents[1];

            // Add date row if necessary
            if (isNewDay) {
                currentDate = moment(eventItem.start).format("YYYY-MM-DD");
                const dateRow = document.createElement("tr");
                dateRow.classList.add("day-header-row");
                dateRow.innerHTML = `
                    <th colspan="1"><div>${moment(currentDate).format("DD.MM.YYYY")}</div></th>
                    <th colspan="1"><div>Titel</div></th>
                    <th colspan="1"><div>Ort</div></th>
                    <th colspan="1"><div>Beschreibung</div></th>
                    `;
                tableBody.appendChild(dateRow);
            }

            const row = document.createElement("tr");
            row.classList.add("event-row");

            if (isNewDay) {
                row.classList.add("is-new-day");
            }

            if (isWholeDayEvent) {
                row.classList.add("whole-day-event-row");
            }

            // Add event row
            row.innerHTML = `
                <td class="event-time">${isWholeDayEvent ? 'Ganztägig' : newStartTime + " - " + newEndTime}</td>
                <td class="event-title">${eventItem.title}</td>
                <td class="event-location">${eventItem.location}</td>
                <td class="event-description">${eventItem.description}</td>
            `;
            tableBody.appendChild(row);
        });
    }
</script>

</html>